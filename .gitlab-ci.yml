stages:
- test
- deploy

test:
  image: python:3.10.6:slim-bookworm
  interruptible: true
  script:
  - pylint *.py
  stage: test

deploy:
  before_script:
  - 'command -v ssh-agent >/dev/null || (apt-get update -y && apt-get install openssh-client -y)'
  - eval $(ssh-agent -s)
  - chmod 400 "$SSH_DEPLOY_KEY"
  - ssh-add "$SSH_DEPLOY_KEY"
  - mkdir -pm 700 ~/.ssh
  environment:
    name: $CI_COMMIT_BRANCH
  image: debian:trixie
  interruptible: true
  needs:
  - test
  script:
  - ssh -oStrictHostKeyChecking=no psychedelic-bot@ai.psychedelic.fi $CI_COMMIT_BRANCH
  stage: deploy
  rules:
  - if: $CI_COMMIT_TAG
    when: never
  - when: on_success
